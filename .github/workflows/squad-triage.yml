name: Squad Triage

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  triage:
    if: github.event.label.name == 'squad'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Triage issue via Lead agent
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;

            // Read team roster to find the Lead and all members
            const teamFile = '.ai-team/team.md';
            if (!fs.existsSync(teamFile)) {
              core.warning('No .ai-team/team.md found â€” cannot triage');
              return;
            }

            const content = fs.readFileSync(teamFile, 'utf8');
            const lines = content.split('\n');

            const members = [];
            let inMembersTable = false;
            for (const line of lines) {
              if (line.startsWith('## Members')) {
                inMembersTable = true;
                continue;
              }
              if (inMembersTable && line.startsWith('## ')) {
                break;
              }
              if (inMembersTable && line.startsWith('|') && !line.includes('---') && !line.includes('Name')) {
                const cells = line.split('|').map(c => c.trim()).filter(Boolean);
                if (cells.length >= 2 && cells[0] !== 'Scribe') {
                  members.push({
                    name: cells[0],
                    role: cells[1]
                  });
                }
              }
            }

            // Read routing rules
            const routingFile = '.ai-team/routing.md';
            let routingContent = '';
            if (fs.existsSync(routingFile)) {
              routingContent = fs.readFileSync(routingFile, 'utf8');
            }

            // Find the Lead
            const lead = members.find(m =>
              m.role.toLowerCase().includes('lead') ||
              m.role.toLowerCase().includes('architect') ||
              m.role.toLowerCase().includes('coordinator')
            );

            if (!lead) {
              core.warning('No Lead role found in team roster â€” cannot triage');
              return;
            }

            // Build triage context
            const memberList = members.map(m =>
              `- **${m.name}** (${m.role}) â†’ label: \`squad:${m.name.toLowerCase()}\``
            ).join('\n');

            // Determine best assignee based on issue content and routing
            const issueText = `${issue.title}\n${issue.body || ''}`.toLowerCase();

            let assignedMember = null;
            let triageReason = '';

            // Simple keyword-based routing as a baseline
            for (const member of members) {
              const role = member.role.toLowerCase();
              if ((role.includes('frontend') || role.includes('ui')) &&
                  (issueText.includes('ui') || issueText.includes('frontend') ||
                   issueText.includes('css') || issueText.includes('component') ||
                   issueText.includes('button') || issueText.includes('page') ||
                   issueText.includes('layout') || issueText.includes('design'))) {
                assignedMember = member;
                triageReason = 'Issue relates to frontend/UI work';
                break;
              }
              if ((role.includes('backend') || role.includes('api') || role.includes('server')) &&
                  (issueText.includes('api') || issueText.includes('backend') ||
                   issueText.includes('database') || issueText.includes('endpoint') ||
                   issueText.includes('server') || issueText.includes('auth'))) {
                assignedMember = member;
                triageReason = 'Issue relates to backend/API work';
                break;
              }
              if ((role.includes('test') || role.includes('qa') || role.includes('quality')) &&
                  (issueText.includes('test') || issueText.includes('bug') ||
                   issueText.includes('fix') || issueText.includes('regression') ||
                   issueText.includes('coverage'))) {
                assignedMember = member;
                triageReason = 'Issue relates to testing/quality work';
                break;
              }
              if ((role.includes('devops') || role.includes('infra') || role.includes('ops')) &&
                  (issueText.includes('deploy') || issueText.includes('ci') ||
                   issueText.includes('pipeline') || issueText.includes('docker') ||
                   issueText.includes('infrastructure'))) {
                assignedMember = member;
                triageReason = 'Issue relates to DevOps/infrastructure work';
                break;
              }
            }

            // Default to Lead if no routing match
            if (!assignedMember) {
              assignedMember = lead;
              triageReason = 'No specific domain match â€” assigned to Lead for further analysis';
            }

            const assignLabel = `squad:${assignedMember.name.toLowerCase()}`;

            // Add the member-specific label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: [assignLabel]
            });

            // Post triage comment
            const comment = [
              `### ðŸ—ï¸ Squad Triage â€” ${lead.name} (${lead.role})`,
              '',
              `**Issue:** #${issue.number} â€” ${issue.title}`,
              `**Assigned to:** ${assignedMember.name} (${assignedMember.role})`,
              `**Reason:** ${triageReason}`,
              '',
              `---`,
              '',
              `**Team roster:**`,
              memberList,
              '',
              `> To reassign, remove the current \`squad:*\` label and add the correct one.`,
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: comment
            });

            core.info(`Triaged issue #${issue.number} â†’ ${assignedMember.name} (${assignLabel})`);
